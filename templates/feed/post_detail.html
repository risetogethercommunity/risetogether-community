{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post by {{ post.author.username }} - Rise Together</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/auth.css' %}">
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
</head>
<body class="bg-black text-white min-h-screen">
    <!-- Background -->
    <div class="background-image"></div>
    <div class="background-overlay"></div>
    
    <!-- Include Sidebar -->
    {% include 'accounts/profile_sidebar.html' %}
    
    <!-- Main Container -->
    <div class="relative z-10 min-h-screen py-8 profile-content">
        <div class="max-w-4xl mx-auto px-4">

            <!-- Back Button -->
            <a href="{% url 'feed:feed_list' %}" class="inline-flex items-center gap-2 text-gray-400 hover:text-white mb-6 transition-colors">
                <i class="fas fa-arrow-left"></i>
                <span class="font-semibold">Back to Feed</span>
            </a>

            <!-- Display Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="glassmorphism text-center p-3 rounded-lg mb-4 {% if message.tags == 'error' %}bg-red-500/20 text-red-400{% else %}bg-green-500/20 text-green-400{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
            
            <!-- Post Card -->
            <div class="glassmorphism rounded-2xl mb-6 overflow-hidden glow-orange">
                <!-- Post Header -->
                <div class="flex items-center gap-3 p-6 border-b border-gray-800">
                    {% if post.author.profile.profile_picture %}
                        <img src="{{ post.author.profile.profile_picture.url }}" alt="{{ post.author.username }}" class="w-14 h-14 rounded-full object-cover border-2 border-orange-500">
                    {% else %}
                        <div class="w-14 h-14 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-xl border-2 border-orange-500">
                            {{ post.author.username|slice:":1"|upper }}
                        </div>
                    {% endif %}
                    <div class="flex-1">
                        <a href="{% url 'accounts:profile' post.author.username %}" class="font-rajdhani font-bold text-xl hover:text-orange-500 transition-colors">
                            {{ post.author.get_full_name|default:post.author.username }}
                        </a>
                        <div class="text-gray-400 text-sm">{{ post.created_at|date:"F d, Y" }} at {{ post.created_at|time:"g:i A" }}</div>
                    </div>
                    {% if post.author == request.user %}
                    <a href="{% url 'feed:delete_post' post.id %}" class="btn-secondary px-4 py-2 rounded-lg text-red-500 hover:bg-red-500/20" onclick="return confirm('Delete this post?');">
                        <i class="fas fa-trash"></i>
                    </a>
                    {% endif %}
                </div>

                <!-- Post Content -->
                {% if post.content %}
                <div class="px-6 py-4 text-gray-200 whitespace-pre-wrap text-lg">{{ post.content }}</div>
                {% endif %}

                <!-- Post Media -->
                {% if post.image %}
                <div class="w-full">
                    <img src="{{ post.image.url }}" alt="Post image" class="w-full object-cover max-h-[700px]">
                </div>
                {% elif post.video %}
                <div class="w-full">
                    <video controls class="w-full max-h-[700px]">
                        <source src="{{ post.video.url }}" type="video/mp4">
                    </video>
                </div>
                {% endif %}

                <!-- Post Stats -->
                <div class="px-6 py-3 border-t border-b border-gray-800 text-gray-400 text-sm">
                    <span class="font-semibold text-white">{{ post.likes.count }}</span> likes · 
                    <span class="font-semibold text-white">{{ post.comments.count }}</span> comments · 
                    <span class="font-semibold text-white">{{ post.views_count }}</span> views
                </div>

                <!-- Post Actions -->
                <div class="flex gap-4 px-6 py-3">
                    <button class="flex-1 btn-secondary py-2 rounded-lg flex items-center justify-center gap-2 {% if user_liked %}text-red-500{% endif %}" 
                            onclick="toggleLike({{ post.id }}, this)">
                        <i class="{% if user_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                        <span class="like-count">{{ post.likes.count }}</span>
                    </button>
                    <button class="flex-1 btn-secondary py-2 rounded-lg flex items-center justify-center gap-2 {% if user_saved %}text-orange-500{% endif %}" 
                            onclick="toggleSave({{ post.id }}, this)">
                        <i class="{% if user_saved %}fas{% else %}far{% endif %} fa-bookmark"></i>
                        Save
                    </button>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="glassmorphism rounded-2xl p-6 glow-orange">
                <h2 class="font-rajdhani text-2xl font-bold mb-6">Comments ({{ comments|length }})</h2>

                {% if comments %}
                    {% for comment in comments %}
                    <div class="pb-4 mb-4 border-b border-gray-800 last:border-0">
                        <div class="flex items-start gap-3">
                            {% if comment.author.profile.profile_picture %}
                                <img src="{{ comment.author.profile.profile_picture.url }}" alt="{{ comment.author.username }}" class="w-10 h-10 rounded-full object-cover">
                            {% else %}
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                    {{ comment.author.username|slice:":1"|upper }}
                                </div>
                            {% endif %}
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <a href="{% url 'accounts:profile' comment.author.username %}" class="font-semibold hover:text-orange-500 transition-colors">
                                        {{ comment.author.get_full_name|default:comment.author.username }}
                                    </a>
                                    <span class="text-gray-500 text-xs">{{ comment.created_at|timesince }} ago</span>
                                </div>
                                <p class="text-gray-200 mb-2">{{ comment.content }}</p>
                                <div class="flex gap-4 text-sm">
                                    <button class="text-gray-400 hover:text-red-500 transition-colors {% if comment.id in user_liked_comments %}text-red-500{% endif %}"
                                            onclick="toggleCommentLike({{ comment.id }}, this)">
                                        <i class="{% if comment.id in user_liked_comments %}fas{% else %}far{% endif %} fa-heart"></i>
                                        <span class="like-count">{{ comment.comment_likes.count }}</span>
                                    </button>
                                    <button class="text-gray-400 hover:text-orange-500 transition-colors" onclick="showReplyForm({{ comment.id }})">
                                        <i class="far fa-comment"></i> Reply
                                    </button>
                                    {% if comment.author == request.user %}
                                    <a href="{% url 'feed:delete_comment' comment.id %}" class="text-gray-400 hover:text-red-500 transition-colors" onclick="return confirm('Delete comment?');">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                    {% endif %}
                                </div>

                                <!-- Reply Form (Hidden) -->
                                <div id="replyForm{{ comment.id }}" class="mt-3 hidden">
                                    <form method="post" action="{% url 'feed:add_comment' post.id %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                        <textarea name="content" class="w-full p-3 bg-white/5 border border-gray-700 rounded-lg text-white resize-none" rows="2" placeholder="Write a reply..." required></textarea>
                                        <div class="flex gap-2 mt-2">
                                            <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold">Reply</button>
                                            <button type="button" class="btn-secondary px-4 py-2 rounded-lg text-sm font-semibold" onclick="hideReplyForm({{ comment.id }})">Cancel</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Replies -->
                                {% if comment.replies_list %}
                                <div class="mt-4 pl-6 border-l-2 border-gray-700 space-y-3">
                                    {% for reply in comment.replies_list %}
                                    <div class="flex items-start gap-3">
                                        {% if reply.author.profile.profile_picture %}
                                            <img src="{{ reply.author.profile.profile_picture.url }}" alt="{{ reply.author.username }}" class="w-8 h-8 rounded-full object-cover">
                                        {% else %}
                                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-white font-bold text-sm">
                                                {{ reply.author.username|slice:":1"|upper }}
                                            </div>
                                        {% endif %}
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <a href="{% url 'accounts:profile' reply.author.username %}" class="font-semibold text-sm hover:text-orange-500 transition-colors">
                                                    {{ reply.author.get_full_name|default:reply.author.username }}
                                                </a>
                                                <span class="text-gray-500 text-xs">{{ reply.created_at|timesince }} ago</span>
                                            </div>
                                            <p class="text-gray-200 text-sm mb-2">{{ reply.content }}</p>
                                            <div class="flex gap-4 text-xs">
                                                <button class="text-gray-400 hover:text-red-500 transition-colors {% if reply.id in user_liked_comments %}text-red-500{% endif %}"
                                                        onclick="toggleCommentLike({{ reply.id }}, this)">
                                                    <i class="{% if reply.id in user_liked_comments %}fas{% else %}far{% endif %} fa-heart"></i>
                                                    <span class="like-count">{{ reply.comment_likes.count }}</span>
                                                </button>
                                                {% if reply.author == request.user %}
                                                <a href="{% url 'feed:delete_comment' reply.id %}" class="text-gray-400 hover:text-red-500 transition-colors" onclick="return confirm('Delete reply?');">
                                                    <i class="fas fa-trash"></i> Delete
                                                </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-8 text-gray-400">
                    <i class="far fa-comments text-5xl mb-3"></i>
                    <p>No comments yet. Be the first to comment!</p>
                </div>
                {% endif %}

                <!-- Add Comment Form -->
                <div class="mt-6 pt-6 border-t border-gray-800">
                    <h3 class="font-semibold mb-3">Add a Comment</h3>
                    <form method="post" action="{% url 'feed:add_comment' post.id %}">
                        {% csrf_token %}
                        <div class="flex gap-3">
                            {% if request.user.profile.profile_picture %}
                                <img src="{{ request.user.profile.profile_picture.url }}" alt="{{ request.user.username }}" class="w-10 h-10 rounded-full object-cover">
                            {% else %}
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold">
                                    {{ request.user.username|slice:":1"|upper }}
                                </div>
                            {% endif %}
                            <div class="flex-1">
                                {{ comment_form.content }}
                                <button type="submit" class="mt-3 btn-primary px-6 py-2 rounded-lg font-semibold">
                                    <i class="fas fa-paper-plane mr-2"></i>Post Comment
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
        textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            min-height: 80px;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: rgba(255, 120, 0, 0.5);
        }
    </style>

    <script>
        // Show Reply Form
        function showReplyForm(commentId) {
            document.getElementById('replyForm' + commentId).classList.remove('hidden');
        }

        // Hide Reply Form
        function hideReplyForm(commentId) {
            document.getElementById('replyForm' + commentId).classList.add('hidden');
        }

        // AJAX Like Toggle
        function toggleLike(postId, button) {
            fetch(`/feed/post/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                const icon = button.querySelector('i');
                if (data.liked) {
                    button.classList.add('text-red-500');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                } else {
                    button.classList.remove('text-red-500');
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                }
                button.querySelector('.like-count').textContent = data.likes_count;
            })
            .catch(error => console.error('Error:', error));
        }

        // AJAX Save Toggle
        function toggleSave(postId, button) {
            fetch(`/feed/post/${postId}/save/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                const icon = button.querySelector('i');
                if (data.saved) {
                    button.classList.add('text-orange-500');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                } else {
                    button.classList.remove('text-orange-500');
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // AJAX Comment Like Toggle
        function toggleCommentLike(commentId, button) {
            fetch(`/feed/comment/${commentId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                const icon = button.querySelector('i');
                if (data.liked) {
                    button.classList.add('text-red-500');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                } else {
                    button.classList.remove('text-red-500');
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                }
                button.querySelector('.like-count').textContent = data.likes_count;
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
